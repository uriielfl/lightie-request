name: Run Tests

on: [push, pull_request]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Clear npm cache
      run: npm cache clean --force

    - name: Delete package-lock.json
      run: rm package-lock.json

    - name: Install Dependencies
      run: npm install

    - name: Run Tests
      run: npm run test:coverage
      
  update_contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup jq
        uses: dcarbone/install-jq-action@v2.1.0

      - name: Fetch author info
        id: author
        run: |
          AUTHOR_NAME=$(curl -s -H "Authorization: token ${{ secrets.CONTRIBUTORS_DEPENDABOT }}" https://api.github.com/users/${{ github.event.pull_request.user.login }} | jq -r ".name")
          AUTHOR_PROFILE=$(curl -s -H "Authorization: token ${{ secrets.CONTRIBUTORS_DEPENDABOT }}" https://api.github.com/users/${{ github.event.pull_request.user.login }} | jq -r ".html_url")
          echo "::set-output name=AUTHOR_NAME::$AUTHOR_NAME"
          echo "::set-output name=AUTHOR_PROFILE::$AUTHOR_PROFILE"

      - name: Update README
        run: |
          echo "- [${{ steps.author.outputs.AUTHOR_NAME }}](${{ steps.author.outputs.AUTHOR_PROFILE }})" >> README.md

      - name: Checkout hml branch
        run: |
          git fetch origin hml:hml
          git checkout hml

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -am "Add contributor"
          git push origin hml
        env:
          GITHUB_TOKEN: ${{ secrets.CONTRIBUTORS_DEPENDABOT }}
